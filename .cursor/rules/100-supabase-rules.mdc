---
description: Database and Auth rules for Supabase + PostGIS
globs: ["src/lib/supabase.ts", "src/hooks/use*.ts"]
alwaysApply: false
---

# Supabase & Data Rules

## PostGIS Integration
- Ride paths are stored as `GEOGRAPHY(LINESTRING, 4326)`.
- When fetching routes, use RPC calls or specific GeoJSON selectors.
- Telemetry precision: Lean angles should be rounded to 1 decimal place.

## Row Level Security (RLS)
- Every query must include a `user_id` check where applicable.
- For tables with `user_id` column: Always filter by `user_id` matching `auth.uid()`.
- For tables without `user_id` (e.g., `maintenance_logs`): RLS policies must enforce access through related tables (e.g., join through `bikes` table).
- Never write code that bypasses RLS in the frontend.

## Schema Reference

### `bikes` table
- `id` (uuid, PK)
- `user_id` (uuid, FK to auth.users.id)
- `make` (text)
- `model` (text)
- `year` (int4, nullable)
- `current_odo` (int4)
- `nick_name` (text, nullable)
- `image_url` (text, nullable)
- `created_at` (timestamptz)

### `rides` table
- `id` (uuid, PK)
- `bike_id` (uuid, FK to bikes.id)
- `user_id` (uuid, FK to auth.users.id)
- `start_time` (timestamptz)
- `end_time` (timestamptz, nullable)
- `distance_km` (numeric)
- `max_lean_left` (numeric) - Stores lean angle in degrees with 1 decimal precision
- `max_lean_right` (numeric) - Stores lean angle in degrees with 1 decimal precision
- `route_path` (geography, LineString, nullable)
- `created_at` (timestamptz)

### `maintenance_logs` table
- `id` (uuid, PK)
- `bike_id` (uuid, FK to bikes.id)
- `service_type` (text, nullable)
- `odo_at_service` (int4)
- `date_performed` (date)
- `notes` (text, nullable)
- `receipt_url` (text, nullable)
- `created_at` (timestamptz)

**Note**: `maintenance_logs` does NOT have a `user_id` column. Access control must be enforced via RLS policies that join through the `bikes` table.

### `fuel_logs` table
- `id` (uuid, PK)
- `bike_id` (uuid, FK to bikes.id)
- `odometer` (int4)
- `litres` (numeric)
- `price_per_litre` (numeric)
- `total_cost` (numeric)
- `is_full_tank` (boolean)
- `date` (date)
- `created_at` (timestamptz)

**Note**: `fuel_logs` does NOT have a `user_id` column. Access control must be enforced via RLS policies that join through the `bikes` table.

## Data Deletion

**MANDATORY**: See `600-deletion-strategy.mdc` for comprehensive deletion rules and patterns.

**Key Points:**
- Always check for related data before deleting bikes
- Block bike deletion if rides exist (critical GPS data)
- Recalculate bike stats after fuel log deletions
- Verify ownership through parent entities for child deletions